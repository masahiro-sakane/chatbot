name: Destroy Google Cloud Resources

on:
  workflow_dispatch:  # 手動実行のみ

env:
  PROJECT_ID: chatbot-481505
  REGION: asia-northeast1
  SERVICE_NAME: chatbot
  REPOSITORY: chatbot-repo

jobs:
  destroy:
    name: Delete Google Cloud Resources
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Delete Cloud Run service
        run: |
          if gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} 2>/dev/null; then
            echo "Deleting Cloud Run service: ${{ env.SERVICE_NAME }}"
            gcloud run services delete ${{ env.SERVICE_NAME }} \
              --region ${{ env.REGION }} \
              --quiet
            echo "✓ Cloud Run service deleted"
          else
            echo "Cloud Run service ${{ env.SERVICE_NAME }} does not exist"
          fi

      - name: Delete Artifact Registry repository
        continue-on-error: true
        run: |
          if gcloud artifacts repositories describe ${{ env.REPOSITORY }} \
              --location=${{ env.REGION }} 2>/dev/null; then
            echo "Deleting Artifact Registry repository (including all images): ${{ env.REPOSITORY }}"
            gcloud artifacts repositories delete ${{ env.REPOSITORY }} \
              --location=${{ env.REGION }} \
              --quiet || echo "⚠ Failed to delete repository via GitHub Actions"
            echo "✓ Artifact Registry repository deletion attempted"
          else
            echo "Artifact Registry repository ${{ env.REPOSITORY }} does not exist"
          fi

      - name: Delete Secret Manager secret
        continue-on-error: true
        run: |
          if gcloud secrets describe anthropic-api-key 2>/dev/null; then
            echo "Deleting Secret Manager secret: anthropic-api-key"
            gcloud secrets delete anthropic-api-key --quiet || echo "⚠ Failed to delete secret via GitHub Actions"
            echo "✓ Secret Manager secret deletion attempted"
          else
            echo "Secret Manager secret anthropic-api-key does not exist"
          fi

      - name: Summary
        run: |
          echo ""
          echo "=== Deletion Summary ==="
          echo "Attempted to delete the following Google Cloud resources:"
          echo "  - Cloud Run service: ${{ env.SERVICE_NAME }}"
          echo "  - Artifact Registry repository: ${{ env.REPOSITORY }}"
          echo "  - Secret Manager secret: anthropic-api-key"
          echo ""
          echo "⚠ Note: If some deletions failed due to IAM permissions,"
          echo "   please run the following commands locally:"
          echo ""
          echo "gcloud artifacts repositories delete ${{ env.REPOSITORY }} --location=${{ env.REGION }} --quiet"
          echo "gcloud secrets delete anthropic-api-key --quiet"
          echo ""
          echo "Workload Identity Federation resources are NOT deleted."
          echo "To delete them, run: ./scripts/cleanup-github-actions.sh"
